<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>School RFID Attendance V3.7</title>
    <style>
:root {
    --primary: #4CAF50;
    --primary-dark: #3a9e43;
    --danger: #e53e3e;
    --bg: #f4f6f9;
    --card: #ffffff;
    --text: #1f2937;
    --muted: #6b7280;
}

* {
    box-sizing: border-box;
}

body {
    font-family: 'Inter', 'Segoe UI', system-ui, sans-serif;
    background: linear-gradient(135deg, #eef2f7, #f8fafc);
    max-width: 1000px;
    margin: auto;
    padding: 1.5rem;
    color: var(--text);
}

.container {
    background: var(--card);
    padding: 1.8rem;
    border-radius: 16px;
    box-shadow: 0 12px 30px rgba(0,0,0,0.06);
    margin-bottom: 24px;
}

h1 {
    font-size: 1.9rem;
    margin-bottom: 1rem;
}

h2 {
    font-size: 1.4rem;
    margin-bottom: 1rem;
}

h3 {
    margin-top: 2rem;
}

select,
input[type="text"],
input[type="file"] {
    width: 100%;
    padding: 12px 14px;
    border-radius: 10px;
    border: 1.8px solid #e5e7eb;
    font-size: 15px;
    transition: all 0.2s ease;
}

select:focus,
input:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(76,175,80,.15);
}

/* RFID Input Highlight */
#attendanceInput {
    font-size: 1.15rem;
    font-weight: bold;
    text-align: center;
    border: 2px dashed var(--primary);
    background: #f0fdf4;
    letter-spacing: 1px;
}

/* Buttons */
button {
    padding: 13px;
    border-radius: 10px;
    border: none;
    font-weight: bold;
    cursor: pointer;
    transition: 0.2s;
}

button:hover {
    transform: translateY(-1px);
}

button:not(.btn-delete) {
    background: var(--primary);
    color: white;
}

button:not(.btn-delete):hover {
    background: var(--primary-dark);
}

.btn-delete {
    background: var(--danger);
    color: white;
    padding: 7px 12px;
    font-size: 12px;
}

.btn-delete:hover {
    background: #c53030;
}

/* Status */
#status {
    margin-top: 15px;
    padding: 14px;
    border-radius: 10px;
    font-weight: bold;
    text-align: center;
    animation: fadeIn 0.3s ease;
}

.success {
    background: #dcfce7;
    color: #166534;
}

.error {
    background: #fee2e2;
    color: #991b1b;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(-6px); }
    to { opacity: 1; transform: translateY(0); }
}

/* Tables */
table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 18px;
    font-size: 0.93rem;
}

th {
    background: var(--primary);
    color: white;
    padding: 12px;
    position: sticky;
    top: 0;
}

td {
    padding: 12px;
    border-bottom: 1px solid #eee;
}

tr:hover {
    background: #f9fafb;
}

/* Images */
.profile-pic,
.no-pic {
    width: 44px;
    height: 44px;
    border-radius: 50%;
}

.profile-pic {
    object-fit: cover;
    border: 2px solid #e5e7eb;
}

.no-pic {
    background: #e5e7eb;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #6b7280;
    font-weight: bold;
}

/* Admin Panel */
.admin-box {
    border: 2px dashed #cbd5e1;
    background: linear-gradient(135deg, #f8fafc, #ffffff);
}

.admin-title {
    text-align: center;
    font-size: 0.75rem;
    letter-spacing: 2px;
    color: #64748b;
    margin-bottom: 12px;
}

/* Form Grid */
.form-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 10px;
}

@media (max-width: 700px) {
    .form-grid {
        grid-template-columns: 1fr;
    }
}
</style>

</head>
<body>

<div class="container">
    <h1>üè´ Daily Attendance Check-in</h1>
    
    <select id="activeSubject" style="border: 2px solid #4CAF50; font-weight: bold;">
        <option value="General">General Attendance</option>
        <option value="Mathematics">Mathematics</option>
        <option value="Science">Science</option>
        <option value="English">English</option>
        <option value="History">History</option>
        <option value="Physical Education">P.E.</option>
    </select>

    <input type="text" id="attendanceInput" placeholder="Scan RFID tag here..." autofocus autocomplete="off">
    <div id="status"></div>

    <h3>üïí Today's Live Log</h3>
    <table id="attendanceTable">
        <thead>
            <tr>
                <th>Photo</th>
                <th>Time</th>
                <th>Name</th>
                <th>Subject</th> <th>Grade</th>
                <th>ID</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<div class="container admin-box">
    <div class="admin-title">Teacher Control Panel</div>
    <h2>‚ûï Register New Student</h2>
    
    <div class="form-grid">
        <input type="text" id="regName" placeholder="Full Name">
        <select id="regGrade">
            <option value="" disabled selected>Select Grade</option>
            <option value="Grade 1">Grade 1</option><option value="Grade 2">Grade 2</option>
            <option value="Grade 3">Grade 3</option><option value="Grade 4">Grade 4</option>
            <option value="Grade 5">Grade 5</option><option value="Grade 6">Grade 6</option>
            <option value="Grade 7">Grade 7</option><option value="Grade 8">Grade 8</option>
            <option value="Grade 9">Grade 9</option><option value="Grade 10">Grade 10</option>
            <option value="Grade 11">Grade 11</option><option value="Grade 12">Grade 12</option>
            <option value="Teacher">Teacher</option>
        </select>
        <select id="regGender">
            <option value="" disabled selected>Select Gender</option>
            <option value="Male">Male</option>
            <option value="Female">Female</option>
            <option value="Other">Other</option>
        </select>
    </div>
    
    <input type="text" id="regSubject" placeholder="Major Subject / Department (e.g. Science)">
    
    <input type="file" id="regPhoto" accept="image/*">
    <input type="text" id="regTag" placeholder="Scan Card to Register ID...">
    <button onclick="registerStudent()">Save Student Profile</button>

    <hr style="margin: 30px 0; border: 0; border-top: 1px solid #ddd;">
    
    <h2>üë• Student Management</h2>
    <table id="managementTable">
        <thead>
            <tr>
                <th>Photo</th>
                <th>Name</th>
                <th>Grade</th>
                <th>Major</th> <th>Tag ID</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getFirestore, collection, addDoc, setDoc, deleteDoc, doc, onSnapshot, query, orderBy, limit, serverTimestamp } 
    from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  // For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyA4wkoriBIuM2BSk6MhebiBEeGgihP88A4",
  authDomain: "rfid-project-d8ede.firebaseapp.com",
  projectId: "rfid-project-d8ede",
  storageBucket: "rfid-project-d8ede.firebasestorage.app",
  messagingSenderId: "710271372713",
  appId: "1:710271372713:web:f9d549fda2106ffe0d08b8",
  measurementId: "G-JLMGYZNRRY"
};
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const toBase64 = file => new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.readAsDataURL(file);
      reader.onload = () => resolve(reader.result);
      reader.onerror = error => reject(error);
  });

  let studentDirectory = {}; 

  // Sync Student Directory & Management Table
  onSnapshot(collection(db, "students"), (snapshot) => {
      const mgmtBody = document.querySelector('#managementTable tbody');
      mgmtBody.innerHTML = '';
      studentDirectory = {};

      snapshot.forEach((doc) => {
          const d = doc.data();
          const id = doc.id;
          studentDirectory[id] = { name: d.name, grade: d.grade, gender: d.gender, photo: d.photo, subject: d.subject };

          const row = `<tr>
              <td>${d.photo ? `<img src="${d.photo}" class="profile-pic">` : `<div class="no-pic">?</div>`}</td>
              <td>${d.name}</td>
              <td>${d.grade}</td>
              <td>${d.subject || '--'}</td>
              <td>${id}</td>
              <td><button class="btn-delete" onclick="deleteStudent('${id}')">Delete</button></td>
          </tr>`;
          mgmtBody.innerHTML += row;
      });
  });

  window.registerStudent = async function() {
      const name = document.getElementById('regName').value.trim();
      const grade = document.getElementById('regGrade').value;
      const gender = document.getElementById('regGender').value;
      const subject = document.getElementById('regSubject').value.trim(); // Get subject
      const tagId = document.getElementById('regTag').value.trim();
      const photoFile = document.getElementById('regPhoto').files[0];

      if (!name || !tagId || !grade) return alert("Fill Name, Grade, and Tag ID!");

      let photoBase64 = null;
      if (photoFile) photoBase64 = await toBase64(photoFile);

      try {
          await setDoc(doc(db, "students", tagId), { 
              name, 
              grade, 
              gender, 
              subject: subject || "N/A", // Save subject
              photo: photoBase64, 
              registeredAt: serverTimestamp() 
          });
          alert("Student Saved!");
          ['regName','regTag','regPhoto','regSubject'].forEach(id => document.getElementById(id).value = '');
          ['regGrade','regGender'].forEach(id => document.getElementById(id).value = '');
      } catch (e) { alert("Error!"); }
  }

  window.deleteStudent = async function(id) {
      if (confirm(`Are you sure you want to delete this student?`)) {
          try {
              await deleteDoc(doc(db, "students", id));
              alert("Deleted successfully.");
          } catch (e) { alert("Delete failed."); }
      }
  }

  const attendanceInput = document.getElementById('attendanceInput');
  attendanceInput.addEventListener('keypress', async (e) => {
      if (e.key === 'Enter' && attendanceInput.value.trim()) {
          const id = attendanceInput.value.trim();
          const activeSub = document.getElementById('activeSubject').value; // Get current class subject
          const student = studentDirectory[id];
          
          try {
              await addDoc(collection(db, "attendance"), {
                  tag_id: id,
                  student_name: student ? student.name : "Unknown",
                  student_grade: student ? student.grade : "--",
                  student_photo: student ? student.photo : null,
                  subject: activeSub, // Log the subject of the session
                  timestamp: serverTimestamp()
              });
              showStatus(student ? `‚úÖ ${student.name} checked into ${activeSub}!` : `‚ö†Ô∏è Unknown Tag`, student ? "success" : "error");
          } catch (e) { showStatus("‚ùå Error", "error"); }
          attendanceInput.value = '';
      }
  });

  function showStatus(msg, type) {
      const div = document.getElementById('status');
      div.textContent = msg; div.className = type; div.style.display = 'block';
      setTimeout(() => div.style.display = 'none', 3000);
  }

  onSnapshot(query(collection(db, "attendance"), orderBy("timestamp", "desc"), limit(10)), (snapshot) => {
      const tbody = document.querySelector('#attendanceTable tbody');
      tbody.innerHTML = ''; 
      snapshot.forEach((doc) => {
          const d = doc.data();
          const time = d.timestamp ? d.timestamp.toDate().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : "---";
          tbody.innerHTML += `<tr>
              <td>${d.student_photo ? `<img src="${d.student_photo}" class="profile-pic">` : `<div class="no-pic">?</div>`}</td>
              <td>${time}</td>
              <td>${d.student_name}</td>
              <td><strong>${d.subject || 'General'}</strong></td>
              <td>${d.student_grade}</td>
              <td>${d.tag_id}</td>
          </tr>`;
      });
  });
</script>
</body>
</html>

