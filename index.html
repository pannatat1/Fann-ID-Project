<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>School RFID Attendance V4.0</title>

<style>
:root {
  --primary:#4CAF50;
  --danger:#e53e3e;
  --card:#ffffff;
  --text:#1f2937;
}

body {
  font-family: system-ui, sans-serif;
  background: linear-gradient(135deg,#eef2f7,#f8fafc);
  max-width:1000px;
  margin:auto;
  padding:20px;
}

.container {
  background:var(--card);
  padding:20px;
  border-radius:16px;
  box-shadow:0 12px 30px rgba(0,0,0,.08);
  margin-bottom:25px;
}

h1,h2 { margin-bottom:12px; }

input,select,button {
  width:100%;
  padding:12px;
  margin-bottom:10px;
  border-radius:10px;
  border:1px solid #ddd;
}

button {
  background:var(--primary);
  color:white;
  font-weight:bold;
  cursor:pointer;
}

#attendanceInput {
  font-size:1.2rem;
  text-align:center;
  border:2px dashed var(--primary);
  background:#f0fdf4;
}

#status {
  padding:12px;
  border-radius:10px;
  font-weight:bold;
  text-align:center;
  display:none;
}

.success { background:#dcfce7; color:#166534; }
.error { background:#fee2e2; color:#991b1b; }

table {
  width:100%;
  border-collapse:collapse;
  margin-top:10px;
}

th,td {
  padding:10px;
  border-bottom:1px solid #eee;
}

th {
  background:var(--primary);
  color:black;
}

.profile {
  width:40px;
  height:40px;
  border-radius:50%;
  object-fit:cover;
}
</style>
</head>

<body>

<div class="container">
<h1>üè´ RFID Attendance</h1>

<select id="activeSubject">
  <option value="General">General</option>
  <option value="Math">Math</option>
  <option value="Science">Science</option>
  <option value="English">English</option>
</select>

<input id="attendanceInput" placeholder="Scan RFID tag..." autofocus>
<div id="status"></div>

<h3>üïí Live Log</h3>
<table>
<thead>
<tr>
<th>Photo</th>
<th>Name</th>
<th>Subject</th>
<th>Status</th>
<th>Check-In</th>
<th>Check-Out</th>
</tr>
</thead>
<tbody id="logBody"></tbody>
</table>
</div>

<div class="container">
<h2>‚ûï Register Student</h2>

<input id="regName" placeholder="Full Name">
<input id="regGrade" placeholder="Grade">
<input id="regTag" placeholder="Scan RFID">
<input type="file" id="regPhoto">
<button onclick="registerStudent()">Save Student</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore, collection, doc, setDoc, getDoc,
  addDoc, updateDoc, onSnapshot, serverTimestamp, query, orderBy, limit
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

// For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyA4wkoriBIuM2BSk6MhebiBEeGgihP88A4",
  authDomain: "rfid-project-d8ede.firebaseapp.com",
  projectId: "rfid-project-d8ede",
  storageBucket: "rfid-project-d8ede.firebasestorage.app",
  messagingSenderId: "710271372713",
  appId: "1:710271372713:web:f9d549fda2106ffe0d08b8",
  measurementId: "G-JLMGYZNRRY"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* RULES */
const RULES = {
  classStart:"08:00",
  classEnd:"15:00",
  lateAfter:15,
  earlyLeaveBefore:30,
  duplicateSeconds:10
};

const students = {};
const input = document.getElementById("attendanceInput");
const statusBox = document.getElementById("status");
const subjectSel = document.getElementById("activeSubject");

/* HELPERS */
const today = () => new Date().toISOString().split("T")[0];
const mins = (a,b)=>Math.floor((a-b)/60000);

function show(msg,type){
  statusBox.textContent = msg;
  statusBox.className = type;
  statusBox.style.display="block";
  setTimeout(()=>statusBox.style.display="none",3000);
}

/* LOAD STUDENTS */
onSnapshot(collection(db,"students"), snap=>{
  snap.forEach(d=>students[d.id]=d.data());
});

/* REGISTER STUDENT */
window.registerStudent = async ()=>{
  const name=regName.value.trim();
  const grade=regGrade.value.trim();
  const tag=regTag.value.trim();
  const photoFile=regPhoto.files[0];

  if(!name||!grade||!tag) return alert("Missing fields");

  let photo=null;
  if(photoFile){
    const r=new FileReader();
    r.onload=()=>photo=r.result;
    r.readAsDataURL(photoFile);
    await new Promise(res=>r.onloadend=res);
  }

  await setDoc(doc(db,"students",tag),{name,grade,photo});
  alert("Student Registered");
};

/* ATTENDANCE SCAN */
input.addEventListener("keypress",async e=>{
  if(e.key!=="Enter"||!input.value.trim())return;

  const tag=input.value.trim();
  const student=students[tag];
  const subject=subjectSel.value;
  const date=today();
  const id=`${tag}_${date}_${subject}`;

  if(!student){
    show("Unknown RFID","error");
    input.value="";
    return;
  }

  const ref=doc(db,"attendance",id);
  const snap=await getDoc(ref);
  const now=new Date();

  if(snap.exists()){
    const d=snap.data();
    if(d.lastScan && (now-d.lastScan.toDate())/1000<RULES.duplicateSeconds){
      show("Duplicate scan ignored","error");
      input.value="";
      return;
    }

    if(!d.checkOut){
      let status=d.status;
      const end=new Date(`${date}T${RULES.classEnd}`);
      if(mins(end,now)>RULES.earlyLeaveBefore) status="Early Leave";

      await updateDoc(ref,{
        checkOut:serverTimestamp(),
        status,
        lastScan:serverTimestamp()
      });

      show(`${student.name} checked OUT`,"success");
    } else {
      show("Attendance already completed","error");
    }
  }
  else {
    const start=new Date(`${date}T${RULES.classStart}`);
    const late=mins(now,start)>RULES.lateAfter;
    const status=late?"Late":"Present";

    await setDoc(ref,{
      tag,
      name:student.name,
      grade:student.grade,
      subject,
      date,
      status,
      checkIn:serverTimestamp(),
      checkOut:null,
      lastScan:serverTimestamp(),
      photo:student.photo
    });

    show(`${student.name} checked IN (${status})`,"success");
  }

  input.value="";
});

/* LIVE LOG */
onSnapshot(
  query(collection(db,"attendance"),orderBy("checkIn","desc"),limit(10)),
  snap=>{
    const body=document.getElementById("logBody");
    body.innerHTML="";
    snap.forEach(d=>{
      const a=d.data();
      body.innerHTML+=`
      <tr>
        <td>${a.photo?`<img class="profile" src="${a.photo}">`:""}</td>
        <td>${a.name}</td>
        <td>${a.subject}</td>
        <td><b>${a.status}</b></td>
        <td>${a.checkIn?.toDate().toLocaleTimeString()||""}</td>
        <td>${a.checkOut?.toDate().toLocaleTimeString()||""}</td>
      </tr>`;
    });
  }
);
</script>

</body>
</html>
